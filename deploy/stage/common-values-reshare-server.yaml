image: "ghcr.io/worldcoin/iris-mpc:v0.8.25"

environment: stage
replicaCount: 1

strategy:
  type: Recreate

datadog:
  enabled: true

# Nginx exposes the only port required here
ports:
  - containerPort: 3000
    name: health
    protocol: TCP

startupProbe:
  httpGet:
    path: /health
    port: health

livenessProbe:
  httpGet:
    path: /health
    port: health

readinessProbe:
  periodSeconds: 30
  failureThreshold: 10
  httpGet:
    path: /health
    port: health

resources:
  limits:
    cpu: 1
    memory: 1Gi
  requests:
    cpu: 1
    memory: 1Gi

imagePullSecrets:
  - name: github-secret

nodeSelector:
  kubernetes.io/arch: amd64
  beta.kubernetes.io/instance-type: t3.2xlarge

podSecurityContext:
  runAsUser: 65534
  runAsGroup: 65534

serviceAccount:
  create: true

command: [ "/bin/reshare-server" ]

env:
  - name: SMPC__DATABASE__URL
    valueFrom:
      secretKeyRef:
        key: DATABASE_AURORA_URL
        name: application
  - name: RUST_LOG
    value: info
  - name: ENVIRONMENT
    value: stage

service:
  enabled: false

nginxSidecar:
  enabled: true
  port: 8443
  secrets:
    enabled: true
    volumeMount:
      - name: mounted-secret-name
        mountPath: /etc/nginx/cert
    volume:
      - name: mounted-secret-name
        secret:
          secretName: application
          items:
            - key: certificate.crt
              path: certificate.crt
            - key: key.pem
              path: key.pem
          optional: false
  config:
    nginx.conf: |
      worker_processes  auto;
      
      error_log  /dev/stderr notice;
      pid        /tmp/nginx.pid;
      
      events {
        worker_connections  1024;
      }
      
      http {
        log_format basic '$remote_addr [$time_local] '
                   '$status $bytes_sent';
      
        access_log /dev/stdout basic;

        server {
          listen 8443 ssl;
          http2 on;
      
          ssl_certificate /etc/nginx/cert/certificate.crt;
          ssl_certificate_key /etc/nginx/cert/key.pem;
      
          ssl_protocols TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;
      
          # Enable session resumption to improve performance
          ssl_session_cache shared:SSL:10m;
          ssl_session_timeout 1h;
      
          location / {
            # Forward gRPC traffic to the gRPC server on port 8000
            grpc_pass grpc://127.0.0.1:8000;
            error_page 502 = /error502grpc;    # Custom error page for GRPC backend issues
          }
      
          # Custom error page
          location = /error502grpc {
            internal;
            default_type text/plain;
            return 502 "Bad Gateway: gRPC server unreachable.";
          }
        }
      }
}
